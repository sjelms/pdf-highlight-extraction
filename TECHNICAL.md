# TECHNICAL SPECIFICATION for pdf-highlight-extraction

## Project Overview

The `pdf-highlight-extraction` project automates the extraction, enrichment, and export of PDF annotations into two primary output formats:

- **Readwise-ready CSV**: A structured CSV file optimized for import into Readwise, containing highlights and enriched bibliographic metadata.
- **Markdown**: A human-readable Markdown file summarizing annotations with contextual metadata, suitable for note-taking apps like Obsidian.

The tool parses PDF highlights, enriches them with bibliographic metadata via BibTeX files, and exports well-structured outputs to streamline knowledge management workflows.

---

## Directory Structure

```
/project-root
│
├── pdf-highlight-extraction.py        # Entry point coordinating the pipeline
├── paperpile.bib                      # Autogenerated bibtex file from paperpile.com; used for lookup
├── annotations.py                     # Extract and process PDF annotations
├── bib.py                             # BibTeX parsing and metadata matching
├── export_json.py                     # Generate JSON exports the "raw" data of the annotations
├── export_csv.py                      # Generate Readwise-ready CSV exports
├── export_md.py                       # Generate Markdown exports of annotations
├── config.yaml                        # Configuration file for paths and options
├── TECHNICAL.md
└── README.md
```

---

## Setup Instructions

### 1. Create a Virtual Environment

```bash
python3 -m venv venv
source venv/bin/activate
```

### 2. Install Dependencies

```bash
pip install -r requirements.txt
```

#### Required Python Packages from requirements.txt
- PyMuPDF
- pydantic
- bibtexparser
- thefuzz[speedup]
- PyYAML


### 3. Configure Paths

- Edit `config.yaml` to specify:
  - Path to PDFs folder
  - Path to BibTeX file(s)
  - Output directories for CSV and Markdown
  - Any optional parameters (e.g., similarity thresholds)

---

## Workflow

The pipeline proceeds as follows:

1.  **PDF Annotation Extraction**  
    Parse each PDF to extract a list of raw highlight annotations.

2.  **Metadata Enrichment via BibTeX**  
    Parse the BibTeX file and match the PDF to a BibTeX entry to retrieve enriched metadata. Matching prefers the PDF filename schema `Title_Authors_Year` (against BibTeX IDs/titles) and falls back to fuzzy title/author matching from embedded PDF metadata.

3.  **Metadata Normalization**
    The matched BibTeX entry is processed by the `normalize_meta` function to clean and standardize the metadata (e.g., title, authors, year).

4.  **Enriched JSON Export**  
    Combine the raw annotations and the normalized metadata into a single, structured JSON file. This file contains a `meta` section for the document-level data and a `data` section for individual highlights. Annotation `text` and `note` are sanitized (CR/LF normalized, HTML entities unescaped, zero‑width and soft hyphens removed, whitespace collapsed, and newlines joined to spaces). JSON is written with `ensure_ascii=False`.

5.  **Final Export Generation**  
    Use the enriched JSON file as the single source of truth to generate the final output files:
    *   A **Readwise-ready CSV file**.
    *   A **Markdown file** with YAML front matter and formatted annotations.

---

## Core Functions

### `extract_annotations(pdf_path: str) -> List[Annotation]`  
Extracts highlight annotations from a PDF file, returning a list of `Annotation` objects. The extracted text is cleaned to remove single line breaks, creating flowing paragraphs.

### `load_bibtex(bibtex_path: str) -> bibtexparser.bibdatabase.BibDatabase`  
Loads and parses a BibTeX file into an internal database structure for efficient lookup.

### `find_bibtex_entry_by_basename(base_filename: str, bib_database: BibDatabase, ...)`  
Matches using the PDF filename (e.g., `Title_Authors_Year`) against BibTeX entry IDs and titles using fuzzy matching.

### `find_bibtex_entry(pdf_title: str, pdf_authors: List[str], bib_database: BibDatabase, title_threshold: int = 80, author_threshold: int = 80)`  
Fallback matcher based on embedded PDF title and authors.

### `normalize_meta(entry: Dict[str, Any]) -> Dict[str, Any]`
Centralizes the cleaning and normalization of metadata from a BibTeX entry. This includes standardizing titles, authors, editors, and other fields to ensure consistency across all export formats.

### `create_enriched_json(pdf_path: str, bib_path: str, output_path: str)`
Orchestrates extraction and enrichment; sanitizes `text` and `note` (newline join, HTML unescape, space normalization) and writes JSON with `ensure_ascii=False`.

### `create_readwise_csv(json_path: str, output_path: str)`
Creates a Readwise-ready CSV file from an enriched JSON file.

### `create_markdown_export(json_path: str, output_path: str)`
Creates a Markdown file from an enriched JSON file.

---

## Matching Strategy

The tool prefers filename-based matching, with fuzzy similarity and robust normalization, and falls back to embedded metadata when needed:

1. **Filename-first**  
   Compare the PDF base name against BibTeX `ID` and `title` via token-set fuzzy matching. The filename schema is assumed to be `Title_Authors_Year` from the reference manager. Normalization collapses separators (`_`, `-`, `.`) into spaces and lowercases for comparison.

2. **Embedded metadata fallback**  
   If no match via filename, compute fuzzy similarity between the embedded PDF `Title` and parsed `Author` list (normalized initials, multi-part surnames) versus BibTeX entries.

3. **Normalization**  
   BibTeX titles are normalized by standardizing separators (colon, hyphen, em dash) to space–en dash–space and collapsing whitespace to improve match stability and alias generation.

4. **Warnings**  
   If no match is found, JSON export succeeds with partial metadata and a console warning; the summary dialog classifies JSON as `warning`.

---

## Data Models

```python
from typing import List, Optional
from datetime import date
from pydantic import BaseModel

class Annotation(BaseModel):
    text: str
    page_number: int
    color: Optional[str] = None
    note: Optional[str] = None

class ParsedName(BaseModel):
    authors: List[str]
    year: Optional[int]
    title: Optional[str]

class MatchResult(BaseModel):
    matched: bool
    bib_entry: Optional[dict] = None
    confidence: float = 0.0

class EnrichedJson(BaseModel):
    meta: dict
    data: List[Annotation]
```

---

## CSV Export Details

This project uses the Readwise CSV import template with the following seven columns and order:

- Title: Matched BibTeX entry title (or PDF metadata/file fallback)
- Author: Concatenated author names from BibTeX (fallbacks as needed)
- Category: Source category, default "articles"
- Source URL: DOI URL when available, else BibTeX `url`, else blank
- Highlight: Annotation text
- Note: Annotation note/comment, if any
- Location: Page number (e.g., "Page 7")

Each row corresponds to one annotation, enriched with metadata for seamless import into Readwise.

### CSV Export — Non-negotiable Field Rules (Readwise template)

1. Column order (exact): `Title, Author, Category, Source URL, Highlight, Note, Location`
2. Highlight: use PDF annotation text (resolve via quadpoints when needed).
3. Title: prefer BibTeX `title`; else PDF metadata `Title`; else cleaned filename fragment.
4. Author: prefer BibTeX authors (joined); else PDF metadata `Author`.
5. Source URL: prefer canonical DOI `https://doi.org/<doi>`; else BibTeX `url`; else blank.
6. Note: user comment if present; do not include color tags here.
7. Location: 1-based page number; formatting may include the word "Page".
8. Encoding: CSV must be UTF-8 with header row; commas as separators; embedded quotes escaped per RFC 4180.
9. Deduplication: optional; if enabled, de-dupe identical `(Highlight, Location)` pairs.

#### Edge cases & fallbacks
- If no BibTeX match: still export, using filename/metadata fallbacks; leave URL blank.
- If annotation text is empty but comment exists: export comment in **Note** and leave **Highlight** blank.
- Preserve line breaks in Highlight by converting to single spaces (Readwise treats CSV fields as single-line).
---

## Markdown Export Notes

- Output includes a YAML header with bibliographic metadata (title, authors, year, DOI, citation key, aliases) followed by an H1 `# Highlights for [[@{citation_key}]]` (or `# Highlights` if no key).
- Each annotation is listed with:
  - Highlight text
  - Page number
  - Highlight color (if available)
  - User notes rendered as a memo block when present and not a verbatim duplicate of the highlight text (whitespace-insensitive)
- Formatting placeholders allow for future styling and linking.
- Markdown is compatible with note-taking apps such as Obsidian.

### BibTeX entry types
- `@article` Used for articles in journals, magazines, or other periodicals.  
- `@book` For citing a complete book with an identifiable publisher.  
- `@booklet` For printed, bound works without a named publisher or sponsoring institution.  
- `@conference` For papers presented at a conference, often interchangeable with `@inproceedings`.  
- `@inbook` To cite a specific part of a book, such as a chapter or a range of pages.  
- `@incollection` For a section of a book that has its own title.  
- `@inproceedings` Used for papers published in conference proceedings.  
- `@manual` For citing software manuals or guides.  
- `@mastersthesis` For Master's theses.  
- `@misc` For resources that don't fit into other categories, such as websites.  
- `@phdthesis` For PhD theses.  
- `@techreport` For technical reports.  


### YAML Header Variants

The exported Markdown files include bibliographic metadata YAML front matter that can specify authors, editors, or both, using standardized keys such as `author`, `authors`, `editor`, or `editors`. This facilitates integration with note-taking systems that parse YAML metadata and ensures proper linkage in Obsidian and consistency with BibTeX references.

**Notes:**
- Title and year
  - `title:` is quoted to ensure safe parsing in Obsidian and YAML
  - Replace any colon `:` in titles and aliases with an en dash ` – ` (space–dash–space)
  - `year:` is plain text
- **Citation key**
  - The `citation-key` field corresponds to the BibTeX entry key matched during processing
  - Must be preserved in the format `"[[ @Key ]]"` within YAML
- **Author and editor fields**
  - Use `author-n` and `editor-n`, numbered sequentially
  - Each name is formatted as `"[[FirstName LastName]]"`
  - All Obsidian wikilinks in YAML must be enclosed in **quotes** and **double brackets**
- BibTeX entry type
  - Convert BibTeX entry type into a tag for YAML
  - Remove the `@` and replace with `#`; append `-pdf`
  - Quote the value to avoid YAML treating it as a comment
  - Example: BibTeX type `@article` becomes `"#article-pdf"`
- **Highlights count**
  - The `highlights:` field must contain the integer count of highlights in the file (no quotes)
- **Add `aliases:` field to citation YAML**
  - Add the **full title** and an optional **short title** (if detected)
  - Example:
    ```yaml
    aliases:
      - A Better Future - Transforming Jobs And Skills For Young People Post-Pandemic
      - A Better Future
    ```
---

**Authors only:**
```yaml
---
title: "Title"
year: 0000
author-1: "[[First Name Last Name]]"
author-2: "[[First Name Last Name]]"
citation-key: "[[@Key]]"
highlights: 000
type: "#article-pdf"
aliases:
      - A Better Future - Transforming Jobs And Skills For Young People Post-Pandemic
      - A Better Future
---
```

**Editors only:**
```yaml
---
title: "Title"
year: 0000
editor-1: "[[First Name Last Name]]"
editor-2: "[[First Name Last Name]]"
citation-key: "[[@Key]]"
highlights: 000
type: "#book-pdf"
aliases:
      - A Better Future - Transforming Jobs And Skills For Young People Post-Pandemic
      - A Better Future
---
```

**Both authors and editors:**
```yaml
---
title: "Title"
year: 0000
author-1: "[[First Name Last Name]]"
author-2: "[[First Name Last Name]]"
editor-1: "[[First Name Last Name]]"
editor-2: "[[First Name Last Name]]"
citation-key: "[[@Key]]"
highlights: 000
type: "#incollection-pdf"
aliases:
      - A Better Future - Transforming Jobs And Skills For Young People Post-Pandemic
      - A Better Future
---
```



### Highlight Formatting Rules

- Highlights are formatted to preserve line breaks and whitespace as closely as possible to the original PDF.
- Annotations with user notes are displayed beneath the highlight text, indented or styled for clarity.
- Each highlight begins with a list item marker `- ` followed by the highlighted text.
- Immediately following the highlight text is a blockquote `>` containing metadata:
  - `page: `00``` indicating the page number where the highlight appears.
  - `tags: #color-tag` where the color tag corresponds to the highlight's color.
- If the annotation includes a user comment, a blank line is added after the metadata block, followed by a `>[!memo]` callout. Multi-line comments are correctly formatted, with each line prefixed by `>`. 

### Color-to-Tag Mapping

Highlight colors are mapped to tags or labels within the Markdown, allowing users to filter or categorize highlights by color. This mapping is configurable and reflected in the Markdown output.

- `#b9e8b9 → #important-pdf`
- `#c3e1f8 → #reference-note-pdf`
- `#f0bbcd → #secondary-pdf`
- `#f9e196 → #general-pdf`

### Whitespace & Callout Requirements

- Proper whitespace around highlights and notes is maintained to ensure readability and compatibility with Markdown parsers.
- Leading and trailing spaces are preserved where meaningful.
- Blank lines separate annotations for visual clarity.
- A mandatory blank line **must** precede the `>[!memo]` callout block to ensure correct rendering.
- Backticks used in page numbers or metadata (e.g., ``page: `00` ``) are preserved exactly as shown.

### Exact Example

```markdown
- This is a highlight
> page: `00`
> tags: #general-pdf

>[!memo]
> This is a comment on the highlight
```

## Error Handling & Logging

- **No-annotation PDFs:** Logs a warning and skips export.
- **Partial Matches:** Logs confidence scores and flags uncertain matches.
- **Malformed BibTeX:** Catches parsing exceptions, logs errors, and continues gracefully.
- **Diagnostics:** Writes detailed logs including file paths, matching attempts, and errors.
- Verbose logging option available for debugging.

---

### Output File Naming Convention

- **Pattern:** `citation-key type.extension`
  - `citation-key` → taken directly from the matched BibTeX entry (without the leading `@`)
  - `type` → derived from the BibTeX entry type, stripped of `@` and prefixed as a YAML tag (e.g., `article-pdf`, `book-pdf`)
  - `extension` → depends on the export format (`.md` for Markdown, `.csv` for Readwise CSV)

- **Examples:**
  - BibTeX entry: `@article{Klein2022-xj,...}`  
    Output files:  
    - `Klein2022-xj article-pdf.md`  
    - `Klein2022-xj article-pdf.csv`
  - BibTeX entry: `@book{Smith2021-ab,...}`  
    Output files:  
    - `Smith2021-ab book-pdf.md`  
    - `Smith2021-ab book-pdf.csv`

- **Notes:**
  - No underscores between key and type — separated by a single space
  - Citation key is preserved exactly as in the BibTeX file
  - Type tag matches the `type:` field in YAML front matter for consistency
  - Ensures unique, Obsidian-friendly filenames and easy linking

---

## Testing & Validation

Testing is planned as a future enhancement. When implemented, it will include:
- Unit tests for annotation extraction, BibTeX parsing, and export formatting.
- Integration tests using sample PDFs and BibTeX files.
- Verification of output consistency using golden files.

---

## Future Enhancements

- Consolidate multiple PDFs into a single CSV export.

---

## Changelog

- 2025-09-05
  - Highlight extraction: switched to quad-based clipping for highlight text (use annotation vertices/quads, sort rects top-to-bottom then left-to-right, fallback to annotation rect). Cleans single newlines to spaces; preserves paragraph breaks. Result: populated `data[].text` in JSON and non-empty Markdown bullets.
  - Color capture: prefer stroke color with fallback to fill; convert RGB floats to hex (e.g., `#f0bbcd`).
  - Author/editor parsing: robust BibTeX name handling. Split on `and` across lines, support "Last, First" → "First Last", preserve multi-part last names (e.g., "LaScola Needy"), strip braces, and normalize initials (e.g., `H.` → `H`). Produces full names such as "Makarand Hastak" and "Kim LaScola Needy".
  - PDF metadata authors: more robust fallback split on commas, semicolons, or the word `and` to improve matching when BibTeX is unavailable.
  - Impact: export formats unchanged; CSV/Markdown now include correct author lists and actual highlight text.

Files affected: `annotations.py`, `bib.py`, `export_json.py`.
- Incorporate DOI lookup APIs for enhanced metadata fetching.
- Implement color mapping for highlight types.
- Add deduplication logic for repeated highlights.
- Support additional export formats (e.g., JSON, HTML).
- Improve fuzzy matching with machine learning techniques.

---

## Command-Line Interface (CLI)

The script can be run from the command line with the following arguments:

- `pdf_path`: (Required) The absolute path to the PDF file to process.
- `--output-dir`: (Optional) Specify a directory to save all output files. This overrides the paths set in `config.yaml`.
- `--no-csv`: (Optional) A flag to disable the CSV export.
- `--no-md`: (Optional) A flag to disable the Markdown export.

### Examples:

**Process a PDF and save to the default output directories:**
```bash
python pdf-highlight-extraction.py /path/to/your/file.pdf
```

**Process a PDF and save all outputs to a specific directory:**
```bash
python pdf-highlight-extraction.py /path/to/your/file.pdf --output-dir /path/to/your/output
```

**Process a PDF and only generate the Markdown file:**
```bash
python pdf-highlight-extraction.py /path/to/your/file.pdf --no-csv
```

---

## Author & Contact

- **Author**: Stephen Elms  
- **GitHub**: [https://github.com/sjelms/pdf-highlight-extraction](https://github.com/sjelms/pdf-highlight-extraction)


## Action Items, Fixes, and Bugs

### 1. Fix `export_md.py` syntax and formatting:
- [x] Correct `.format` placeholders for authors/editors (migrated to f-strings).
- [x] Fix bad citation key formatting.
- [x] Quote YAML `type:` value.
- [x] Quote aliases.
- [x] Move color map creation outside the loop.
- [x] Sanitize colons in Title and Aliases (replace `:` with ` – `).
- [x] Fix multi-line memo formatting.

### 2. Fix `annotations.py` robustness and text extraction:
- [x] Safe iteration over `page.annots()`.
- [x] Remove unused `wordlist` variables.
- [x] Improve highlight text extraction by using `annot.get_text("text")`.
- [x] Defensive `color` handling.
- [x] Clean up highlight text to remove single newlines.

### 3. Enhance `export_json.py`:
- [x] Normalize authors for fuzzy matching by using `normalize_meta`.

### 4. Enhance `export_csv.py`:
- [x] Prefer DOI for `Source URL`.

### 5. Update `pdf-highlight-extraction.py`:
- [x] Add CLI switches for flexible execution.
