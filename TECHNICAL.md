# TECHNICAL SPECIFICATION for pdf-highlight-extraction

## Project Overview

The `pdf-highlight-extraction` project automates the extraction, enrichment, and export of PDF annotations into two primary output formats:

- **Readwise-ready CSV**: A structured CSV file optimized for import into Readwise, containing highlights and enriched bibliographic metadata.
- **Markdown**: A human-readable Markdown file summarizing annotations with contextual metadata, suitable for note-taking apps like Obsidian.

The tool parses PDF highlights, enriches them with bibliographic metadata via BibTeX files, and exports well-structured outputs to streamline knowledge management workflows.

---

## Directory Structure

```
/project-root
│
├── pdf-highlight-extraction.py        # Entry point coordinating the pipeline
├── paperpile.bib                      # Autogenerated bibtex file from paperpile.com; used for lookup
├── annotations.py                     # Extract and process PDF annotations
├── bib.py                             # BibTeX parsing and metadata matching
├── export_json.py                     # Generate JSON exports the "raw" data of the annotations
├── export_csv.py                      # Generate Readwise-ready CSV exports
├── export_md.py                       # Generate Markdown exports of annotations
├── utils.py                           # Utility functions (logging, parsing helpers)
├── config.yaml                        # Configuration file for paths and options
├── tests/                             # Unit and integration tests
│   ├── test_annotations.py
│   ├── test_bib.py
│   ├── test_export.py
│   └── fixtures/
│       ├── sample.pdf
│       ├── sample.bib
│       └── expected.csv
├── TECHNICAL.md
└── README.md
```

---

## Setup Instructions

### 1. Create a Virtual Environment

```bash
python3 -m venv venv
source venv/bin/activate
```

### 2. Install Dependencies

```bash
pip install -r requirements.txt
```

#### Required Python Packages from requirements.txt
- PyMuPDF
- pydantic
- bibtexparser
- thefuzz[speedup]
- PyYAML


### 3. Configure Paths

- Edit `config.yaml` to specify:
  - Path to PDFs folder
  - Path to BibTeX file(s)
  - Output directories for CSV and Markdown
  - Any optional parameters (e.g., similarity thresholds)

---

## Workflow

The pipeline proceeds as follows:

1.  **PDF Annotation Extraction**  
    Parse each PDF to extract a list of raw highlight annotations.

2.  **Metadata Enrichment via BibTeX**  
    Parse the BibTeX file and match the PDF to a BibTeX entry to retrieve enriched metadata (e.g., citation key, full author names, publication year).

3.  **Enriched JSON Export**  
    Combine the raw annotations and the enriched metadata into a single, structured JSON file. This file will contain a `meta` section for the document-level data and a `data` section for the list of individual highlights.

4.  **Final Export Generation**  
    Use the enriched JSON file as the single source of truth to generate the final output files:
    *   A **Readwise-ready CSV file**.
    *   A **Markdown file** with YAML front matter and formatted annotations.

---

## Core Functions

### `extract_annotations(pdf_path: str) -> List[Annotation]`  
Extracts highlight annotations from a PDF file, returning a list of `Annotation` objects containing text, page number, color, and notes.

### `resolve_highlight_text(page: PdfPage, annot: PdfAnnotation) -> str`  
Given a PDF page and an annotation object, extracts and cleans the highlighted text content.

### `parse_filename_metadata(filename: str) -> ParsedName`  
Parses a PDF filename to extract metadata such as author(s), year, and title components for matching.

### `load_bibtex(bibtex_path: str) -> BibDB`  
Loads and parses a BibTeX file into an internal database structure for efficient lookup.

### `find_bibtex_entry_by_title_and_authors(title: str, authors: List[str], bibtex_path: str) -> dict | None`  
Searches the BibTeX database for an entry matching the given title and author list; returns the matching entry or None.

### `parse_bibtex_entry(citation_key: str, bibtex_path: str) -> Optional[Dict[str, Any]]`  
Extracts detailed metadata fields from a BibTeX entry identified by its citation key.

### `bibtex_to_yaml_names(bibtex_authors: str) -> List[str]`  
Converts BibTeX author strings into a list of standardized author names suitable for YAML or other structured formats.

### `match_pdf_to_bib(pdf_meta: ParsedName, parsed_name: ParsedName, bibdb: BibDB) -> MatchResult`  
Performs heuristic matching between extracted PDF metadata and BibTeX entries, returning a `MatchResult` with matching status and matched entry.

### `build_readwise_rows(annotations: List[Annotation], match: MatchResult) -> List[Dict[str, str]]`  
Constructs a list of dictionaries representing rows for the Readwise CSV export, mapping annotation and metadata fields.

### `write_readwise_csv(rows: List[Dict[str, str]], out_path: str)`  
Writes the Readwise CSV rows to the specified output file with appropriate headers.

### `write_markdown(annotations: List[Annotation], match: MatchResult, out_path: str)`  
Generates a Markdown file summarizing annotations with enriched metadata and writes it to the specified path.

---

## Matching Strategy

The matching between PDF metadata and BibTeX entries uses a stepwise heuristic:

1. **Filename Parsing**  
   Extract author(s), year, and title fragments from the PDF filename.

2. **Title Similarity**  
   Compute string similarity (e.g., Levenshtein or fuzzy matching) between extracted title and BibTeX titles.

3. **Author Overlap**  
   Compare parsed authors with BibTeX author lists for overlap and ordering.

4. **Year Check**  
   Confirm that the publication year matches or is within a small tolerance.

5. **DOI Matching**  
   If available, compare DOI fields for exact matches.

6. **Fallbacks**  
   Use partial title matches or truncated author lists for ambiguous cases.

7. **Truncation Handling**  
   Handle incomplete or abbreviated filenames gracefully.

The goal is to maximize precision while allowing for minor inconsistencies in naming conventions.

---

## Data Models

```python
from typing import List, Optional
from datetime import date
from pydantic import BaseModel

class Annotation(BaseModel):
    text: str
    page: int
    color: Optional[str] = None
    note: Optional[str] = None

class ParsedName(BaseModel):
    authors: List[str]
    year: Optional[int]
    title: Optional[str]

class MatchResult(BaseModel):
    matched: bool
    bib_entry: Optional[dict] = None
    confidence: float = 0.0

class EnrichedJson(BaseModel):
    meta: dict
    data: List[Annotation]
```

---

## CSV Export Details

This project uses the Readwise CSV import template with the following seven columns and order:

- Title: Matched BibTeX entry title (or PDF metadata/file fallback)
- Author: Concatenated author names from BibTeX (fallbacks as needed)
- Category: Source category, default "articles"
- Source URL: DOI URL when available, else BibTeX `url`, else blank
- Highlight: Annotation text
- Note: Annotation note/comment, if any
- Location: Page number (e.g., "Page 7")

Each row corresponds to one annotation, enriched with metadata for seamless import into Readwise.

### CSV Export — Non-negotiable Field Rules (Readwise template)

1. Column order (exact): `Title, Author, Category, Source URL, Highlight, Note, Location`
2. Highlight: use PDF annotation text (resolve via quadpoints when needed).
3. Title: prefer BibTeX `title`; else PDF metadata `Title`; else cleaned filename fragment.
4. Author: prefer BibTeX authors (joined); else PDF metadata `Author`.
5. Source URL: prefer canonical DOI `https://doi.org/<doi>`; else BibTeX `url`; else blank.
6. Note: user comment if present; do not include color tags here.
7. Location: 1-based page number; formatting may include the word "Page".
8. Encoding: CSV must be UTF-8 with header row; commas as separators; embedded quotes escaped per RFC 4180.
9. Deduplication: optional; if enabled, de-dupe identical `(Highlight, Location)` pairs.

#### Edge cases & fallbacks
- If no BibTeX match: still export, using filename/metadata fallbacks; leave URL blank.
- If annotation text is empty but comment exists: export comment in **Note** and leave **Highlight** blank.
- Preserve line breaks in Highlight by converting to single spaces (Readwise treats CSV fields as single-line).
---

## Markdown Export Notes

- Output includes a header with bibliographic metadata (title, authors, year, DOI).
- Each annotation is listed with:
  - Highlight text
  - Page number
  - Highlight color (if available)
  - User notes
- Formatting placeholders allow for future styling and linking.
- Markdown is compatible with note-taking apps such as Obsidian.

### BibTeX entry types
- `@article` Used for articles in journals, magazines, or other periodicals.  
- `@book` For citing a complete book with an identifiable publisher.  
- `@booklet` For printed, bound works without a named publisher or sponsoring institution.  
- `@conference` For papers presented at a conference, often interchangeable with `@inproceedings`.  
- `@inbook` To cite a specific part of a book, such as a chapter or a range of pages.  
- `@incollection` For a section of a book that has its own title.  
- `@inproceedings` Used for papers published in conference proceedings.  
- `@manual` For citing software manuals or guides.  
- `@mastersthesis` For Master's theses.  
- `@misc` For resources that don't fit into other categories, such as websites.  
- `@phdthesis` For PhD theses.  
- `@techreport` For technical reports.  


### YAML Header Variants

The exported Markdown files include bibliographic metadata YAML front matter that can specify authors, editors, or both, using standardized keys such as `author`, `authors`, `editor`, or `editors`. This facilitates integration with note-taking systems that parse YAML metadata and ensures proper linkage in Obsidian and consistency with BibTeX references.

**Notes:**
- Title and year
  - `title:` is quoted to ensure safe parsing in Obsidian and YAML
  - Replace any colon `:` in titles and aliases with an en dash ` – ` (space–dash–space)
  - `year:` is plain text
- **Citation key**
  - The `citation-key` field corresponds to the BibTeX entry key matched during processing
  - Must be preserved in the format `"[[ @Key ]]"` within YAML
- **Author and editor fields**
  - Use `author-n` and `editor-n`, numbered sequentially
  - Each name is formatted as `"[[FirstName LastName]]"`
  - All Obsidian wikilinks in YAML must be enclosed in **quotes** and **double brackets**
- BibTeX entry type
  - Convert BibTeX entry type into a tag for YAML
  - Remove the `@` and replace with `#`; append `-pdf`
  - Quote the value to avoid YAML treating it as a comment
  - Example: BibTeX type `@article` becomes `"#article-pdf"`
- **Highlights count**
  - The `highlights:` field must contain the integer count of highlights in the file (no quotes)
- **Add `aliases:` field to citation YAML**
  - Add the **full title** and an optional **short title** (if detected)
  - Example:
    ```yaml
    aliases:
      - A Better Future - Transforming Jobs And Skills For Young People Post-Pandemic
      - A Better Future
    ```
---

**Authors only:**
```yaml
---
title: "Title"
year: 0000
author-1: "[[First Name Last Name]]"
author-2: "[[First Name Last Name]]"
citation-key: "[[@Key]]"
highlights: 000
type: "#article-pdf"
aliases:
      - A Better Future - Transforming Jobs And Skills For Young People Post-Pandemic
      - A Better Future
---
```

**Editors only:**
```yaml
---
title: "Title"
year: 0000
editor-1: "[[First Name Last Name]]"
editor-2: "[[First Name Last Name]]"
citation-key: "[[@Key]]"
highlights: 000
type: "#book-pdf"
aliases:
      - A Better Future - Transforming Jobs And Skills For Young People Post-Pandemic
      - A Better Future
---
```

**Both authors and editors:**
```yaml
---
title: "Title"
year: 0000
author-1: "[[First Name Last Name]]"
author-2: "[[First Name Last Name]]"
editor-1: "[[First Name Last Name]]"
editor-2: "[[First Name Last Name]]"
citation-key: "[[@Key]]"
highlights: 000
type: "#incollection-pdf"
aliases:
      - A Better Future - Transforming Jobs And Skills For Young People Post-Pandemic
      - A Better Future
---
```



### Highlight Formatting Rules

- Highlights are formatted to preserve line breaks and whitespace as closely as possible to the original PDF.
- Annotations with user notes are displayed beneath the highlight text, indented or styled for clarity.
- Each highlight begins with a list item marker `- ` followed by the highlighted text.
- Immediately following the highlight text is a blockquote `>` containing metadata:
  - `page: \`00\`` indicating the page number where the highlight appears.
  - `tags: #color-tag` where the color tag corresponds to the highlight's color.
- If the annotation includes a user comment (the `Text` field in the JSON annotation), add a blank line after the metadata block and then:
  ```
  >[!memo]
  > Comment text
  ```

### Color-to-Tag Mapping

Highlight colors are mapped to tags or labels within the Markdown, allowing users to filter or categorize highlights by color. This mapping is configurable and reflected in the Markdown output.

- `#b9e8b9 → #important-pdf`
- `#c3e1f8 → #reference-note-pdf`
- `#f0bbcd → #secondary-pdf`
- `#f9e196 → #general-pdf`

### Whitespace & Callout Requirements

- Proper whitespace around highlights and notes is maintained to ensure readability and compatibility with Markdown parsers.
- Leading and trailing spaces are preserved where meaningful.
- Blank lines separate annotations for visual clarity.
- A mandatory blank line **must** precede the `>[!memo]` callout block to ensure correct rendering.
- Backticks used in page numbers or metadata (e.g., ``page: `00` ``) are preserved exactly as shown.

### Exact Example

```
- This is a highlight
> page: `00`
> tags: #general-pdf

>[!memo]
> This is a comment on the highlight
```

## Error Handling & Logging

- **No-annotation PDFs:** Logs a warning and skips export.
- **Partial Matches:** Logs confidence scores and flags uncertain matches.
- **Malformed BibTeX:** Catches parsing exceptions, logs errors, and continues gracefully.
- **Diagnostics:** Writes detailed logs including file paths, matching attempts, and errors.
- Verbose logging option available for debugging.

---

### Output File Naming Convention

- **Pattern:** `citation-key type.extension`
  - `citation-key` → taken directly from the matched BibTeX entry (without the leading `@`)
  - `type` → derived from the BibTeX entry type, stripped of `@` and prefixed as a YAML tag (e.g., `article-pdf`, `book-pdf`)
  - `extension` → depends on the export format (`.md` for Markdown, `.csv` for Readwise CSV)

- **Examples:**
  - BibTeX entry: `@article{Klein2022-xj,...}`  
    Output files:  
    - `Klein2022-xj article-pdf.md`  
    - `Klein2022-xj article-pdf.csv`
  - BibTeX entry: `@book{Smith2021-ab,...}`  
    Output files:  
    - `Smith2021-ab book-pdf.md`  
    - `Smith2021-ab book-pdf.csv`

- **Notes:**
  - No underscores between key and type — separated by a single space
  - Citation key is preserved exactly as in the BibTeX file
  - Type tag matches the `type:` field in YAML front matter for consistency
  - Ensures unique, Obsidian-friendly filenames and easy linking

---

## Testing & Validation

- Unit tests cover:
  - Annotation extraction correctness
  - BibTeX parsing and matching logic
  - CSV and Markdown export formatting
- Integration tests use fixtures with sample PDFs and BibTeX files.
- Golden files (`expected.csv`, `expected.md`) used to verify output consistency.
- Edge cases tested:
  - PDFs with no highlights
  - BibTeX entries with missing fields
  - Filename irregularities
  - Multiple authors and ambiguous matches

---

## Future Enhancements

- Consolidate multiple PDFs into a single CSV export.
- Incorporate DOI lookup APIs for enhanced metadata fetching.
- Implement color mapping for highlight types.
- Add deduplication logic for repeated highlights.
- Support additional export formats (e.g., JSON, HTML).
- Improve fuzzy matching with machine learning techniques.

---

## Author & Contact

- **Author**: Stephen Elms  
- **GitHub**: [https://github.com/sjelms/pdf-highlight-extraction](https://github.com/sjelms/pdf-highlight-extraction)


## Action Items, Fixes, and Bugs

### 1. Fix `export_md.py` syntax and formatting:
- [x] Correct `.format` placeholders for authors/editors (migrated to f-strings).
- [x] Fix bad citation key formatting.
- [x] Quote YAML `type:` value.
- [x] Quote aliases.
- [x] Move color map creation outside the loop.
- [x] Sanitize colons in Title and Aliases (replace `:` with ` – `).

### 2. Fix `annotations.py` robustness and text extraction:
- [ ] Safe iteration over `page.annots()`.
- [ ] Remove unused `wordlist` variables.
- [ ] Improve highlight text extraction using `quads`.
- [ ] Defensive `color` handling.

### 3. Enhance `export_json.py`:
- [ ] Normalize authors for fuzzy matching.

### 4. Enhance `export_csv.py`:
- [ ] Prefer DOI for `Source URL`.

### 5. Update `pdf-highlight-extraction.py`:
- [ ] Consider adding CLI switches.

### 6. Update `TECHNICAL.md` for consistency:
- [x] CSV schema mismatch (documented Readwise header order used in code).
- [x] YAML `type:` value quoting (examples and guidance updated).
- [ ] Tests referenced in `TECHNICAL.md` do not exist.
- [ ] `utils.py` is empty.

#### Issue 1: Fix `export_md.py` syntax and formatting
  - [x] Sub-issue 1.1: Correct `.format` placeholders for authors/editors
    - Resolution: Replaced with f-strings writing `author-{i}: "[[Name]]"` and `editor-{i}: "[[Name]]"`.
  - [x] Sub-issue 1.2: Fix bad citation key formatting
    - Resolution: Now writes `citation-key: "[[@Key]]"`.
  - [x] Sub-issue 1.3: Quote YAML `type:` value
    - Resolution: Now writes `type: "#<entry-type>-pdf"`.
  - [x] Sub-issue 1.4: Quote aliases
    - Resolution: Each alias list item is quoted.
  - [x] Sub-issue 1.5: Move color map creation outside the loop
    - Resolution: Color map is defined once before iterating annotations.
  - [x] Sub-issue 1.6: Sanitize colons in Title and Aliases
    - Resolution: Colons `:` replaced with ` – ` in title and aliases to avoid Obsidian formatting issues.
